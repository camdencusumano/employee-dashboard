// Google Sheets API configuration
const SHEET_ID = '1I3xgchN40_D8lkKjJrGgXr8lWt02RvldBOxCH1Pzk_k';
const API_KEY = 'AIzaSyD11ci9BCpFABOp09iNT6G_0sw6cmMKx3k';
const BASE_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/`;

// Sheet names mapped to tabs (assumed to match tab names)
const sheetNames = {
    tab1: 'BOH-NUGGETS_Breader',
    tab2: 'BOH-NUGGETS_Assembler',
    tab3: 'BOH-WAFFLE FRIES_Assembler',
    tab4: 'BOH-GRILLED_Assembler',
    tab5: 'BOH-GRILLED_Breader',
    tab6: 'BOH-CFA_Buns',
    tab7: 'BOH-GRILLED_Buns',
    tab8: 'BOH-CFA_Assembler',
    tab9: 'BOH-CFA_Breader'
};

// Column definitions for each tab
const columns = {
    tab1: [
        'Timestamp', 'Score', 'NAME OF BREADER (First Name, Last Initial)',
        'MEDIUM: Nuggets meet color requirement',
        'HIGH: Nuggets are entirely covered in a generous layer of seasoned coater, free of large lumps or uncooked coater',
        'MEDIUM: Nuggets are free of bare spots', 'NAME OF INSPECTOR'
    ],
    tab2: [
        'Timestamp', 'Score', 'NAME OF ASSEMBLER (First Name, Last Initial)',
        'Internal temperature of cooked Nuggets (Diagnostic Only)',
        'LOW: Nugget box has “N” tab pressed',
        'LOW: Outside of menu tab box is free of excessive staining collectively larger than a nickel',
        'Outside of packaging is free of residue, product, or excessive fingerprints, or smudges due to handling (Nuggets)',
        'LOW: CFA Nugget box contains no more than one scrap',
        'HIGH: Number of Chick-fil-A Nuggets present (no more or less than 8)',
        'NAME OF INSPECTOR', 'MEDIUM: Nuggets are free of bare spots'
    ],
    tab3: [
        'Timestamp', 'Score', 'NAME OF ASSEMBLER (First Name, Last Initial)',
        'INFORMATIONAL: Internal Temperature of Waffle Potato Fries',
        'HIGH: Waffle Potato Fry package appears full',
        'INFORMATIONAL: Outside of packaging is free of residue, product, or excessive fingerprints, or smudges',
        'HIGH: Waffle Potato Fries are evenly cooked (crisp on outside and soft inside) not scorched or soggy',
        'MEDIUM: Waffle Potato Fries meet color requirements',
        'MEDIUM: There are not an excessive number of small pieces', 'NAME OF INSPECTOR'
    ],
    tab4: [
        'Timestamp', 'Score', 'NAME OF ASSEMBLER (First Name, Last Initial)',
        'Internal Temperature of Grilled Filet (Diagnostic Only)',
        'LOW: Clamshell is securely closed with both locking tabs secured, product not protruding from clamshell',
        'LOW: Outside of clamshell is free of excessive staining larger than a quarter',
        'LOW: Outside of clamshell is free of residue, product, or excessive fingerprints, or smudges due to handling larger than a quarter',
        'LOW: Grilled Chicken Sandwich is served in a sandwich sleeve inside clamshell',
        'LOW: Best grill marks on grilled filet are facing up',
        'MEDIUM: Multigrain brioche bun is not torn or crushed, with no flaking or peeling',
        'MEDIUM: There are 2 whole slices (3 if small) of tomato. (3/16" thick)',
        'LOW: Tomato slices have no visible core, no hole in center, no end slices',
        'MEDIUM: There are 2 Green Leaf lettuce leaves on grilled sandwich',
        'LOW: Lettuce leaf diameter is approximately 4" (+/-0.5")', 'NAME OF INSPECTOR',
        'HIGH: Grilled filet has acceptable bun coverage',
        'LOW: Multigrain brioche bun is toasted to the correct color',
        'HIGH: Grilled filet is free of excessive carbon build up (both sides)'
    ],
    tab5: [
        'Timestamp', 'Score', 'NAME OF BREADER (First Name, Last Initial)',
        'LOW: Grilled chicken is correct color (best grill marks side)',
        'HIGH: Grilled filet is free of excessive carbon build up (both sides)',
        'HIGH: Grilled filet has acceptable bun coverage',
        'Weight of cooked grilled filet (Diagnostic)', 'NAME OF INSPECTOR'
    ],
    tab6: [
        'Timestamp', 'Score', 'NAME OF BUNS (First Name, Last Initial)',
        'MEDIUM: There are 2 well drained pickle chips (3 if small) on sandwich',
        'LOW: Pickles overlap by no more than a quarter of pickle area',
        'LOW: Pickles are not hanging off bun heel',
        'LOW: White hamburger-style bun crown (top) is buttered with butter-flavored oil',
        'LOW: White hamburger-style bun crown is toasted evenly to correct color',
        'LOW: White hamburger-style bun heel is toasted evenly to correct color',
        'NAME OF INSPECTOR',
        'LOW: White hamburger-style bun heel (bottom) is buttered with butter-flavored oil',
        'MEDIUM: White bun is not torn or crushed, with no flaking or peeling'
    ],
    tab7: [
        'Timestamp', 'Score', 'NAME OF BUNS (First Name, Last Initial)',
        'MEDIUM: Multigrain brioche bun is not torn or crushed, with no flaking or peeling',
        'LOW: Multigrain brioche bun crown (top) is toasted evenly to correct color',
        'LOW: Multigrain brioche bun heel (bottom) is toasted evenly to correct color',
        'NAME OF INSPECTOR'
    ],
    tab8: [
        'Timestamp', 'Score', 'NAME OF ASSEMBLER (First Name, Last Initial)',
        'LOW: Outside of packaging is free of excessive staining collectively larger than a quarter (Chick-fil-A Sandwich)',
        'LOW: Outside of packaging is free of residue, product, or excessive fingerprints, or smudges due to handling',
        'LOW: Top of foil bag is pressed in and folded down twice (each fold 1/2” in width) to cover and secure opening of bag',
        'MEDIUM: White hamburger-style bun is not torn or crushed, with no flaking or peeling',
        'HIGH: Chick-fil-A regular filet has acceptable bun coverage',
        'MEDIUM: Chick-fil-A regular filet is golden brown in appearance',
        'HIGH: Side facing up: Chick-fil-A filet is entirely covered in a generous layer of seasoned coater, free of large lumps or uncooked coater',
        'MEDIUM: Total area of bare spots on Chick-fil-A regular filet is no larger than a quarter',
        'NAME OF INSPECTOR',
        'HIGH: Chick-fil-A regular filet has acceptable bun coverage'
    ],
    tab9: [
        'Timestamp', 'Score', 'NAME OF BREADER (First Name, Last Initial)',
        'HIGH: Side facing up: Chick-fil-A filet is entered covered in a generous layer of seasoned coater, free of large lumps or uncooked coater',
        'INFORMATIONAL: Weight of cooked Chick-fil-A regular filet is at least 3.3 oz',
        'MEDIUM: Total area of bare spots on Chick-fil-A regular filet is no larger than a quarter (side facing up only)',
        'MEDIUM: Chick-fil-A regular filet is golden brown in appearance',
        'HIGH: Chick-fil-A filet has acceptable bun coverage', 'NAME OF INSPECTOR'
    ]
};

// Tab navigation
function openTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tab-link[onclick="openTab('${tabId}')"]`).classList.add('active');
}

// Fetch and render data for a tab
async function loadTabData(tabId) {
    try {
        const response = await fetch(`${BASE_URL}${sheetNames[tabId]}!A1:Z1000?key=${API_KEY}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        // Convert API response to array of objects
        const headers = data.values[0];
        const rows = data.values.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, i) => {
                obj[header] = row[i] || '';
            });
            return obj;
        });

        // Render table
        const table = document.getElementById(`table${tabId.slice(3)}`);
        table.innerHTML = '';
        const thead = document.createElement('thead');
        const tr = document.createElement('tr');
        columns[tabId].forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            tr.appendChild(th);
        });
        thead.appendChild(tr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        rows.forEach(row => {
            const tr = document.createElement('tr');
            columns[tabId].forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] || '';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        // Render individual chart for tabs 1, 3, 5, 7
        if ([1, 3, 5, 7].includes(parseInt(tabId.slice(3)))) {
            const scores = {};
            rows.forEach(row => {
                const name = row['NAME OF BREADER (First Name, Last Initial)'] ||
                            row['NAME OF ASSEMBLER (First Name, Last Initial)'] ||
                            row['NAME OF BUNS (First Name, Last Initial)'];
                const score = parseFloat(row['Score']);
                if (name && !isNaN(score) && score > 0) {
                    if (!scores[name]) scores[name] = { total: 0, count: 0 };
                    scores[name].total += score;
                    scores[name].count += 1;
                }
            });

            const labels = Object.keys(scores);
            const avgScores = labels.map(name => scores[name].total / scores[name].count);

            ```chartjs
            {
                "type": "bar",
                "data": {
                    "labels": ${JSON.stringify(labels)},
                    "datasets": [{
                        "label": "Average Test Score",
                        "data": ${JSON.stringify(avgScores)},
                        "backgroundColor": "rgba(0, 123, 255, 0.6)",
                        "borderColor": "rgba(0, 123, 255, 1)",
                        "borderWidth": 1
                    }]
                },
                "options": {
                    "scales": {
                        "y": {
                            "beginAtZero": true,
                            "title": {
                                "display": true,
                                "text": "Average Score"
                            }
                        },
                        "x": {
                            "title": {
                                "display": true,
                                "text": "Name"
                            }
                        }
                    },
                    "plugins": {
                        "title": {
                            "display": true,
                            "text": "${sheetNames[tabId]} Scores"
                        },
                        "legend": {
                            "display": false
                        }
                    }
                }
            }
